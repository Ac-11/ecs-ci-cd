name: S3 and CloudFront Update

on:
  push:
    branches:
      - main

jobs:
  update-s3-cloudfront:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-2
      S3_BUCKET: nodejs-frontend-abhisth
      CLOUDFRONT_DISTRIBUTION_ID: ET3G5V79QW5ID

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step: Check for changes in frontend/ directory
      - name: Check for frontend changes
        id: check_changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep '^frontend/'; then
            echo "Frontend changes detected."
            echo "frontend_changed=true" >> $GITHUB_ENV
          else
            echo "No frontend changes detected."
            echo "frontend_changed=false" >> $GITHUB_ENV
          fi

      # Step: Configure AWS credentials
      - name: Configure AWS credentials
        if: env.frontend_changed == 'true'
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::651706780098:role/GitHubAction-AssumeRole
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ env.AWS_REGION }}

      # Step: Rename existing index.html in S3
      - name: Rename existing index.html in S3
        if: env.frontend_changed == 'true'
        run: |
          TIMESTAMP=$(date +%s)
          if aws s3 ls "s3://${{ env.S3_BUCKET }}/index.html"; then
            COUNT=$(aws s3 ls s3://${{ env.S3_BUCKET }} | grep "record-" | wc -l)
            NEW_RECORD="record-$(($COUNT + 1)).html"
            echo "Renaming current index.html to $NEW_RECORD"
            aws s3 mv s3://${{ env.S3_BUCKET }}/index.html s3://${{ env.S3_BUCKET }}/$NEW_RECORD
          else
            echo "No existing index.html found. Skipping rename step."
          fi

      # Step: Upload new index.html to S3
      - name: Upload new index.html to S3
        if: env.frontend_changed == 'true'
        run: |
          aws s3 cp frontend/index.html s3://${{ env.S3_BUCKET }}/index.html

      # Step: Invalidate CloudFront Cache
      - name: Invalidate CloudFront Cache
        if: env.frontend_changed == 'true'
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
